<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Portfolio Â· Live NAV Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0f14;--surface:#13161e;--surface2:#1a1e28;--border:#252933;
    --accent:#00e5a0;--accent2:#3d8bff;--warn:#ff6b6b;--gold:#f5c842;--text:#e8eaf0;--muted:#6b7385}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
  body::before{content:'';position:fixed;top:-200px;left:-200px;width:700px;height:700px;
    background:radial-gradient(circle,rgba(0,229,160,0.07) 0%,transparent 70%);pointer-events:none;z-index:0}
  body::after{content:'';position:fixed;bottom:-200px;right:-200px;width:600px;height:600px;
    background:radial-gradient(circle,rgba(61,139,255,0.05) 0%,transparent 70%);pointer-events:none;z-index:0}
  .wrap{max-width:960px;margin:0 auto;padding:32px 18px;position:relative;z-index:1}

  #loader{position:fixed;inset:0;background:var(--bg);z-index:999;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity 0.5s}
  #loader.hide{opacity:0;pointer-events:none}
  .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);
    border-radius:50%;animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #loader p{font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--muted);text-align:center;padding:0 20px}

  .hdr{margin-bottom:28px}
  .hdr-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
  .hdr h1{font-family:'DM Serif Display',serif;font-size:2rem;line-height:1.15}
  .hdr h1 span{color:var(--accent)}
  .hdr p{font-size:0.82rem;color:var(--muted);margin-top:4px}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .sync-btn{display:flex;align-items:center;gap:7px;background:rgba(245,200,66,0.08);
    border:1px solid rgba(245,200,66,0.22);padding:8px 14px;border-radius:999px;
    font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--gold);cursor:pointer;transition:background 0.2s;font-weight:600}
  .sync-btn:hover{background:rgba(245,200,66,0.16)}
  .live-btn{display:flex;align-items:center;gap:7px;background:rgba(0,229,160,0.08);
    border:1px solid rgba(0,229,160,0.22);padding:8px 14px;border-radius:999px;
    font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--accent);cursor:pointer;transition:background 0.2s;font-weight:600}
  .live-btn:hover{background:rgba(0,229,160,0.16)}
  .dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.25}}

  .goal-bar{margin-top:14px;background:var(--surface);border:1px solid var(--border);
    border-radius:12px;padding:14px 20px;display:flex;gap:24px;flex-wrap:wrap;align-items:center}
  .gi .gl{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em}
  .gi .gv{font-family:'DM Mono',monospace;font-size:0.92rem;margin-top:3px;font-weight:600}
  .col-green{color:var(--accent)}.col-blue{color:var(--accent2)}.col-gold{color:var(--gold)}.col-muted{color:var(--muted)}

  #setup{background:var(--surface);border:1px solid rgba(245,200,66,0.3);
    border-radius:14px;padding:24px;margin-bottom:24px;display:none}
  #setup h3{font-family:'DM Serif Display',serif;color:var(--gold);margin-bottom:12px}
  #setup p{font-size:0.78rem;color:var(--muted);margin-bottom:16px;line-height:1.6}
  .input-row{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .input-row label{font-size:0.78rem;color:var(--muted);min-width:130px}
  .input-row input{flex:1;min-width:260px;background:var(--surface2);border:1px solid var(--border);
    color:var(--text);padding:10px 12px;border-radius:8px;font-family:'DM Mono',monospace;font-size:0.78rem}
  .input-row input:focus{border-color:var(--accent2);outline:none}
  .connect-btn{background:var(--accent2);border:none;color:#fff;font-family:'DM Sans',sans-serif;
    font-weight:600;font-size:0.85rem;padding:10px 22px;border-radius:9px;cursor:pointer;transition:opacity 0.2s}
  .connect-btn:hover{opacity:0.85}

  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:12px;margin-bottom:28px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 16px;
    transition:border-color 0.2s,transform 0.2s;animation:fadeUp 0.5s ease both}
  .card:hover{border-color:rgba(0,229,160,0.28);transform:translateY(-2px)}
  @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}
  .card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
  .card .cl{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:7px}
  .card .cv{font-family:'DM Mono',monospace;font-size:1.2rem;font-weight:500}
  .card .cs{font-size:0.73rem;color:var(--muted);margin-top:3px}
  .g{color:var(--accent)}.r{color:var(--warn)}.b{color:var(--accent2)}.go{color:var(--gold)}

  .sec{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);
    margin-bottom:12px;display:flex;align-items:center;gap:10px;margin-top:28px}
  .sec::after{content:'';flex:1;height:1px;background:var(--border)}
  .sec.first{margin-top:0}

  .fund{background:var(--surface);border:1px solid var(--border);border-radius:14px;
    padding:20px;margin-bottom:12px;transition:border-color 0.2s,transform 0.2s;animation:fadeUp 0.5s ease both}
  .fund:hover{border-color:rgba(61,139,255,0.28);transform:translateY(-1px)}
  .fund-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
  .fund-left{display:flex;gap:14px}
  .ficon{width:42px;height:42px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;
    justify-content:center;font-family:'DM Mono',monospace;font-size:0.68rem;font-weight:600;color:#fff}
  .fname{font-weight:600;font-size:0.9rem;line-height:1.35}
  .ftype{font-size:0.7rem;color:var(--muted);margin-top:3px}
  .folio-tag{background:rgba(61,139,255,0.08);border:1px solid rgba(61,139,255,0.15);color:var(--muted);
    font-size:0.63rem;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:999px;
    margin-top:5px;display:inline-block}
  .nav-badge{font-family:'DM Mono',monospace;font-size:0.75rem;background:rgba(0,229,160,0.07);
    border:1px solid rgba(0,229,160,0.15);padding:6px 12px;border-radius:8px;color:var(--accent);
    white-space:nowrap;text-align:center;min-width:220px}
  .nav-badge.loading{opacity:0.5;animation:blink 1.2s infinite}
  .nav-badge.error{color:var(--warn);border-color:rgba(255,107,107,0.2);background:rgba(255,107,107,0.05)}
  @keyframes blink{0%,100%{opacity:0.5}50%{opacity:0.2}}
  .fnums{display:flex;gap:20px;flex-wrap:wrap;margin-top:16px;padding-top:14px;border-top:1px solid var(--border)}
  .ni .nl{font-size:0.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em}
  .ni .nv{font-family:'DM Mono',monospace;font-size:0.9rem;margin-top:3px;font-weight:600}
  .bar-track{background:var(--surface2);border-radius:999px;height:4px;margin-top:14px;overflow:hidden}
  .bar-fill{height:100%;border-radius:999px}

  .status{text-align:center;font-family:'DM Mono',monospace;font-size:0.72rem;
    color:var(--muted);margin:8px 0 20px;padding:10px}
  .status.ok{color:var(--accent)}.status.err{color:var(--warn)}.status.info{color:var(--accent2)}
  .refresh-btn{display:block;margin:16px auto 28px;background:rgba(0,229,160,0.08);
    border:1px solid rgba(0,229,160,0.22);color:var(--accent);font-family:'DM Mono',monospace;
    font-size:0.75rem;padding:9px 20px;border-radius:9px;cursor:pointer;transition:background 0.2s;font-weight:600}
  .refresh-btn:hover{background:rgba(0,229,160,0.18)}

  .proj-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:28px}
  .proj-box h3{font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:18px}
  .slider-row{display:flex;align-items:center;gap:14px;margin-bottom:20px;flex-wrap:wrap}
  .slider-row label{font-size:0.78rem;color:var(--muted)}
  input[type=range]{-webkit-appearance:none;width:150px;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;
    border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(0,229,160,0.45)}
  #rate-val{font-family:'DM Mono',monospace;color:var(--accent);font-size:0.9rem;min-width:38px}
  .proj-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
  .pi{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
  .pi.hi{background:linear-gradient(135deg,rgba(0,229,160,0.12),rgba(61,139,255,0.12));border-color:rgba(0,229,160,0.28)}
  .pi .pl{font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px}
  .pi .pv{font-family:'DM Mono',monospace;font-size:1rem;font-weight:600}
  .pi.hi .pv{color:var(--accent);font-size:1.2rem}
  .prog-wrap{margin-top:18px}
  .prog-labels{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-bottom:6px}
  .prog-track{background:var(--surface2);border-radius:999px;height:10px;overflow:hidden}
  .prog-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 0.5s ease}
  .prog-pct{text-align:center;font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--accent2);margin-top:5px}

  @media(max-width:520px){.hdr h1{font-size:1.5rem}.fnums{gap:12px}.nav-badge{min-width:unset}}
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p id="loader-msg">Loading portfolio from GitHubâ€¦</p>
</div>

<div class="wrap">

  <div class="hdr">
    <div class="hdr-top">
      <div>
        <h1>My Portfolio<br><span>Live NAV Tracker</span></h1>
        <p>Automated from Zapier + GitHub Â· Live NAV from AMFI</p>
      </div>
      <div class="btn-row">
        <button class="sync-btn" onclick="loadPortfolio()">â†» &nbsp;Sync from GitHub</button>
        <button class="live-btn" onclick="fetchAllNAVs()"><div class="dot"></div> LIVE NAV</button>
      </div>
    </div>
    <div class="goal-bar">
      <div class="gi"><div class="gl">Total Invested</div><div class="gv col-blue" id="hdr-inv">â€”</div></div>
      <div class="gi"><div class="gl">Portfolio Value</div><div class="gv col-green" id="hdr-val">â€”</div></div>
      <div class="gi"><div class="gl">Total Gain/Loss</div><div class="gv" id="hdr-gain">â€”</div></div>
      <div class="gi"><div class="gl">Last Synced</div><div class="gv col-muted" id="sync-time">â€”</div></div>
    </div>
  </div>

  <div id="setup">
    <h3>ðŸ”— GitHub Configuration</h3>
    <p>One-time setup. Enter your GitHub details to read your portfolio CSV files from the data/history/ folder.</p>
    <div class="input-row">
      <label>GitHub Username</label>
      <input type="text" id="gh-user" placeholder="your-github-username">
    </div>
    <div class="input-row">
      <label>Repository</label>
      <input type="text" id="gh-repo" placeholder="portfolio-cas-data">
    </div>
    <div class="input-row">
      <label>Personal Access Token</label>
      <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
    </div>
    <div class="input-row">
      <label>Goal Amount (â‚¹)</label>
      <input type="number" id="goal-amount" value="2000000">
    </div>
    <button class="connect-btn" onclick="saveGitHubConfig()">ðŸ”Œ &nbsp;Connect Dashboard</button>
  </div>

  <div class="cards">
    <div class="card"><div class="cl">Total Invested</div><div class="cv b" id="kpi-inv">â€”</div><div class="cs" id="kpi-funds">â€”</div></div>
    <div class="card"><div class="cl">Live Value</div><div class="cv g" id="kpi-val">â€”</div><div class="cs">With live NAV</div></div>
    <div class="card"><div class="cl">Total Gain / Loss</div><div class="cv" id="kpi-gain">â€”</div><div class="cs" id="kpi-pct">â€”</div></div>
    <div class="card"><div class="cl">Holdings</div><div class="cv go" id="kpi-count">â€”</div><div class="cs">Transactions</div></div>
  </div>

  <div class="sec first">Current Holdings (With Live NAV)</div>
  <div id="current-holdings"></div>

  <div class="status" id="status"></div>
  <button class="refresh-btn" onclick="fetchAllNAVs()">âŸ³ &nbsp;Refresh Live NAV</button>

  <div class="sec">All Transaction History</div>
  <div id="transaction-history"></div>

  <div class="sec">Wealth Projection</div>
  <div class="proj-box">
    <h3>Corpus Estimator</h3>
    <div class="slider-row">
      <label>Expected Annual Return:</label>
      <input type="range" id="rate" min="6" max="15" value="8" step="0.5" oninput="calcProj()">
      <span id="rate-val">8%</span>
    </div>
    <div class="proj-grid">
      <div class="pi"><div class="pl">Current Value</div><div class="pv" id="p-corpus">â€”</div></div>
      <div class="pi"><div class="pl">Monthly SIP</div><div class="pv" id="p-sip">â‚¹10,000</div></div>
      <div class="pi"><div class="pl">Growth Earned</div><div class="pv" id="p-growth">â€”</div></div>
      <div class="pi hi"><div class="pl">ðŸŽ¯ Future Value</div><div class="pv" id="p-total">â€”</div></div>
    </div>
    <div class="prog-wrap">
      <div class="prog-labels"><span id="prog-l">Now: â€”</span><span id="prog-r">Target: â€”</span></div>
      <div class="prog-track"><div class="prog-fill" id="prog" style="width:0%"></div></div>
      <div class="prog-pct" id="prog-pct">â€”</div>
    </div>
  </div>

</div>

<script>
// â”€â”€ AMFI ISIN Code Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ISIN_CODES = {
  'kotak-arbitrage-fund': 'INF174K01LC6',
  'icici-prudential-multi-asset-fund': 'INF109K015K4',
  'icici-prudential-equity-savings-fund': 'INF109KA11J9'
};

const FUND_META = {
  'kotak': { short: 'KA', cs: '#1a56db', ce: '#3d8bff' },
  'icici-multi': { short: 'MA', cs: '#f59e0b', ce: '#fbbf24' },
  'icici-equity': { short: 'ES', cs: '#0e9f6e', ce: '#34d399' },
};

let allTransactions = [], currentHoldings = {};
let liveCorpus = 0, GOAL = 2000000, SIP = 10000;
let navCache = {}; // Cache for NAV data

const inr = v => 'â‚¹' + Math.round(v).toLocaleString('en-IN');
const inrL = v => v >= 1e5 ? 'â‚¹' + (v / 1e5).toFixed(2) + 'L' : inr(v);
const mo = (a, b) => (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveGitHubConfig() {
  const user = document.getElementById('gh-user').value;
  const repo = document.getElementById('gh-repo').value;
  const token = document.getElementById('gh-token').value;
  const goal = document.getElementById('goal-amount').value;
  
  if (!user || !repo || !token) {
    setStatus('err', 'âš  All fields required');
    return;
  }
  
  localStorage.setItem('gh_user', user);
  localStorage.setItem('gh_repo', repo);
  localStorage.setItem('gh_token', token);
  localStorage.setItem('goal', goal);
  
  GOAL = parseInt(goal);
  document.getElementById('setup').style.display = 'none';
  loadPortfolio();
}

function showSetup() {
  const user = localStorage.getItem('gh_user');
  if (user) {
    document.getElementById('gh-user').value = user;
    document.getElementById('gh-repo').value = localStorage.getItem('gh_repo');
    document.getElementById('gh-token').value = localStorage.getItem('gh_token');
    document.getElementById('goal-amount').value = localStorage.getItem('goal') || '2000000';
  }
  document.getElementById('setup').style.display = 'block';
  document.getElementById('loader').classList.add('hide');
}

// â”€â”€ Load from GitHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPortfolio() {
  const user = localStorage.getItem('gh_user');
  const repo = localStorage.getItem('gh_repo');
  const token = localStorage.getItem('gh_token');
  
  if (!user || !repo || !token) {
    showSetup();
    return;
  }
  
  GOAL = parseInt(localStorage.getItem('goal') || '2000000');
  
  document.getElementById('loader-msg').textContent = 'Loading from GitHubâ€¦';
  document.getElementById('loader').classList.remove('hide');
  
  try {
    const url = `https://api.github.com/repos/${user}/${repo}/contents/data/history`;
    const res = await fetch(url, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    
    if (!res.ok) throw new Error('GitHub folder not found');
    
    const files = await res.json();
    const csvFiles = files.filter(f => f.name.endsWith('.csv')).sort().reverse();
    
    allTransactions = [];
    currentHoldings = {};
    
    for (let file of csvFiles) {
      const csvRes = await fetch(file.download_url);
      const csv = await csvRes.text();
      const lines = csv.trim().split('\n').slice(1);
      
      lines.forEach(line => {
        if (!line) return;
        const parts = line.split(',');
        const txn = {
          date: parts[0],
          folio: parts[1],
          fundHouse: parts[2],
          fundName: parts[3].replace(/"/g, ''),
          invested: parseFloat(parts[4]),
          units: parseFloat(parts[5]),
          historicalNAV: parseFloat(parts[6]),
          historicalValue: parseFloat(parts[7])
        };
        
        allTransactions.push(txn);
        
        const key = txn.folio + '|' + txn.fundName;
        if (!currentHoldings[key]) {
          currentHoldings[key] = {
            folio: txn.folio,
            fundHouse: txn.fundHouse,
            fundName: txn.fundName,
            units: 0,
            invested: 0,
            liveValue: 0,
            liveNAV: txn.historicalNAV,
            isin: getISIN(txn.fundName)
          };
        }
        currentHoldings[key].units += txn.units;
        currentHoldings[key].invested += txn.invested;
      });
    }
    
    render();
    document.getElementById('sync-time').textContent = new Date().toLocaleTimeString('en-IN');
    fetchAllNAVs();
    
  } catch (err) {
    console.error(err);
    document.getElementById('loader').classList.add('hide');
    setStatus('err', 'âš  Failed to load: ' + err.message);
  }
}

// â”€â”€ Get ISIN Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getISIN(fundName) {
  const n = fundName.toLowerCase();
  for (let key in ISIN_CODES) {
    if (n.includes(key)) {
      return ISIN_CODES[key];
    }
  }
  return null;
}

// â”€â”€ Parse AMFI NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function parseAMFIData() {
  try {
    const res = await fetch('https://www.amfiindia.com/spages/NAVAll.txt');
    const text = await res.text();
    
    const lines = text.split('\n');
    const data = {};
    
    lines.forEach(line => {
      if (!line.trim()) return;
      const parts = line.split(';');
      if (parts.length >= 4) {
        const isin = parts[0].trim();
        const nav = parseFloat(parts[3].trim());
        const date = parts[2]?.trim() || 'N/A';
        
        if (!isNaN(nav)) {
          data[isin] = { nav, date };
        }
      }
    });
    
    navCache = data;
    console.log('AMFI data parsed:', Object.keys(navCache).length, 'funds');
    return true;
  } catch (err) {
    console.error('AMFI parse error:', err);
    return false;
  }
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const holdings = Object.values(currentHoldings);
  const totalInv = holdings.reduce((s, h) => s + h.invested, 0);
  const totalVal = holdings.reduce((s, h) => s + h.liveValue, 0);
  const gain = totalVal - totalInv;
  const gainPct = totalInv > 0 ? (gain / totalInv * 100).toFixed(2) : 0;
  
  document.getElementById('hdr-inv').textContent = inr(totalInv);
  document.getElementById('hdr-val').textContent = inr(totalVal);
  document.getElementById('hdr-gain').textContent = (gain >= 0 ? '+' : 'âˆ’') + inr(Math.abs(gain));
  document.getElementById('hdr-gain').className = 'gv ' + (gain >= 0 ? 'col-green' : 'col-red');
  
  document.getElementById('kpi-inv').textContent = inr(totalInv);
  document.getElementById('kpi-funds').textContent = holdings.length + ' funds';
  document.getElementById('kpi-val').textContent = inr(totalVal);
  document.getElementById('kpi-gain').textContent = (gain >= 0 ? '+' : 'âˆ’') + inr(Math.abs(gain));
  document.getElementById('kpi-gain').className = 'cv ' + (gain >= 0 ? 'g' : 'r');
  document.getElementById('kpi-pct').textContent = (gainPct >= 0 ? '+' : '') + gainPct + '%';
  document.getElementById('kpi-pct').className = 'cs ' + (gainPct >= 0 ? 'g' : 'r');
  document.getElementById('kpi-count').textContent = allTransactions.length;
  
  // Current Holdings
  const chDom = document.getElementById('current-holdings');
  chDom.innerHTML = '';
  
  holdings.forEach((h, i) => {
    const gain2 = h.liveValue - h.invested;
    const gainPct2 = h.invested > 0 ? ((gain2 / h.invested) * 100).toFixed(2) : 0;
    const pct = ((h.invested / totalInv) * 100).toFixed(1);
    
    const getMeta = (name) => {
      const n = name.toLowerCase();
      if (n.includes('kotak')) return FUND_META['kotak'];
      if (n.includes('multi')) return FUND_META['icici-multi'];
      if (n.includes('equity') || n.includes('saving')) return FUND_META['icici-equity'];
      return { short: name.slice(0, 2).toUpperCase(), cs: '#6b7385', ce: '#9ca3af' };
    };
    
    const meta = getMeta(h.fundName);
    
    const card = document.createElement('div');
    card.className = 'fund';
    card.style.animationDelay = (i * 0.08) + 's';
    card.innerHTML = `
      <div class="fund-top">
        <div class="fund-left">
          <div class="ficon" style="background:linear-gradient(135deg,${meta.cs},${meta.ce})">${meta.short}</div>
          <div>
            <div class="fname">${h.fundName}</div>
            <div class="ftype">${h.fundHouse}</div>
            <div class="folio-tag">Folio ${h.folio}</div>
          </div>
        </div>
        <div class="nav-badge loading" id="nb-${i}">Fetching NAVâ€¦</div>
      </div>
      <div class="fnums">
        <div class="ni"><div class="nl">Invested</div><div class="nv">${inr(h.invested)}</div></div>
        <div class="ni"><div class="nl">Units</div><div class="nv">${h.units.toFixed(4)}</div></div>
        <div class="ni"><div class="nl">Avg NAV</div><div class="nv">â‚¹${(h.invested / h.units).toFixed(4)}</div></div>
        <div class="ni"><div class="nl">Live NAV</div><div class="nv" id="lnav-${i}">â€”</div></div>
        <div class="ni"><div class="nl">Live Value</div><div class="nv" id="lval-${i}">â€”</div></div>
        <div class="ni"><div class="nl">Gain/Loss</div><div class="nv ${gain2 >= 0 ? 'g' : 'r'}">${gain2 >= 0 ? '+' : 'âˆ’'}${inr(Math.abs(gain2))} (${gainPct2}%)</div></div>
        <div class="ni"><div class="nl">Portfolio</div><div class="nv">${pct}%</div></div>
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:linear-gradient(90deg,${meta.cs},${meta.ce})"></div></div>
    `;
    chDom.appendChild(card);
  });
  
  // Transaction History
  const thDom = document.getElementById('transaction-history');
  thDom.innerHTML = '';
  
  allTransactions.forEach((t, i) => {
    const card = document.createElement('div');
    card.className = 'fund';
    card.style.animationDelay = (i * 0.05) + 's';
    
    const getMeta = (name) => {
      const n = name.toLowerCase();
      if (n.includes('kotak')) return FUND_META['kotak'];
      if (n.includes('multi')) return FUND_META['icici-multi'];
      if (n.includes('equity') || n.includes('saving')) return FUND_META['icici-equity'];
      return { short: name.slice(0, 2).toUpperCase(), cs: '#6b7385', ce: '#9ca3af' };
    };
    
    const meta = getMeta(t.fundName);
    
    card.innerHTML = `
      <div class="fund-top">
        <div class="fund-left">
          <div class="ficon" style="background:linear-gradient(135deg,${meta.cs},${meta.ce})">${meta.short}</div>
          <div>
            <div class="fname">${t.fundName}</div>
            <div class="ftype">${t.fundHouse}</div>
            <div class="folio-tag">${t.date}</div>
          </div>
        </div>
      </div>
      <div class="fnums">
        <div class="ni"><div class="nl">Invested</div><div class="nv">${inr(t.invested)}</div></div>
        <div class="ni"><div class="nl">Units</div><div class="nv">${t.units.toFixed(4)}</div></div>
        <div class="ni"><div class="nl">NAV at Purchase</div><div class="nv">â‚¹${t.historicalNAV.toFixed(4)}</div></div>
        <div class="ni"><div class="nl">Value at Purchase</div><div class="nv">${inr(t.historicalValue)}</div></div>
      </div>
    `;
    thDom.appendChild(card);
  });
  
  liveCorpus = totalVal;
  calcProj();
  document.getElementById('loader').classList.add('hide');
}

// â”€â”€ Live NAV from AMFI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAllNAVs() {
  if (!Object.keys(currentHoldings).length) return;
  
  setStatus('', 'ðŸ“ˆ Fetching live NAV from AMFIâ€¦');
  
  // Parse AMFI data once
  const parsed = await parseAMFIData();
  if (!parsed) {
    setStatus('err', 'âš  Failed to fetch AMFI data');
    return;
  }
  
  // Update each holding
  const holdings = Object.values(currentHoldings);
  holdings.forEach((h, i) => {
    const nb = document.getElementById(`nb-${i}`);
    const lnav = document.getElementById(`lnav-${i}`);
    const lval = document.getElementById(`lval-${i}`);
    
    if (!nb) return;
    
    if (!h.isin) {
      nb.className = 'nav-badge error';
      nb.textContent = 'ISIN not found';
      lnav.textContent = 'â€”';
      lval.textContent = inr(h.liveValue);
      return;
    }
    
    const navData = navCache[h.isin];
    if (navData) {
      h.liveValue = h.units * navData.nav;
      h.liveNAV = navData.nav;
      
      nb.className = 'nav-badge';
      nb.textContent = `NAV â‚¹${navData.nav.toFixed(4)} Â· ${navData.date}`;
      lnav.textContent = `â‚¹${navData.nav.toFixed(4)}`;
      lval.textContent = inr(h.liveValue);
    } else {
      nb.className = 'nav-badge error';
      nb.textContent = 'NAV not found in AMFI';
      lnav.textContent = 'â€”';
      lval.textContent = inr(h.liveValue);
    }
  });
  
  // Update totals
  const totalVal = holdings.reduce((s, h) => s + h.liveValue, 0);
  const totalInv = holdings.reduce((s, h) => s + h.invested, 0);
  const gain = totalVal - totalInv;
  const gainPct = totalInv > 0 ? (gain / totalInv * 100).toFixed(2) : 0;
  
  document.getElementById('hdr-val').textContent = inr(totalVal);
  document.getElementById('kpi-val').textContent = inr(totalVal);
  document.getElementById('hdr-gain').textContent = (gain >= 0 ? '+' : 'âˆ’') + inr(Math.abs(gain));
  document.getElementById('hdr-gain').className = 'gv ' + (gain >= 0 ? 'col-green' : 'col-red');
  document.getElementById('kpi-gain').textContent = (gain >= 0 ? '+' : 'âˆ’') + inr(Math.abs(gain));
  document.getElementById('kpi-gain').className = 'cv ' + (gain >= 0 ? 'g' : 'r');
  document.getElementById('kpi-pct').textContent = (gainPct >= 0 ? '+' : '') + gainPct + '%';
  document.getElementById('kpi-pct').className = 'cs ' + (gainPct >= 0 ? 'g' : 'r');
  
  liveCorpus = totalVal;
  calcProj();
  
  setStatus('ok', 'âœ“ NAV updated from AMFI Â· ' + new Date().toLocaleTimeString('en-IN'));
}

// â”€â”€ Projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcProj() {
  const rate = parseFloat(document.getElementById('rate').value);
  document.getElementById('rate-val').textContent = rate + '%';
  
  const r = rate / 100 / 12;
  const months = mo(new Date(), new Date(2027, 11, 6));
  const c = liveCorpus || Object.values(currentHoldings).reduce((s, h) => s + h.invested, 0);
  
  const fvC = c * Math.pow(1 + r, months);
  const fvS = SIP * ((Math.pow(1 + r, months) - 1) / r) * (1 + r);
  const tot = fvC + fvS;
  const grow = tot - c - SIP * months;
  const pct = Math.min((tot / GOAL) * 100, 100);
  
  document.getElementById('p-corpus').textContent = inrL(c);
  document.getElementById('p-growth').textContent = inrL(grow);
  document.getElementById('p-total').textContent = inrL(tot);
  document.getElementById('prog-l').textContent = 'Now: ' + inrL(c);
  document.getElementById('prog-r').textContent = 'Target: ' + inrL(GOAL);
  document.getElementById('prog').style.width = pct + '%';
  document.getElementById('prog-pct').textContent = pct.toFixed(1) + '% of ' + inrL(GOAL);
}

function setStatus(cls, msg) {
  const el = document.getElementById('status');
  el.className = 'status ' + (cls ? cls : '');
  el.textContent = msg;
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const savedUser = localStorage.getItem('gh_user');
if (savedUser) {
  loadPortfolio();
} else {
  showSetup();
}
</script>

</body>
</html>
