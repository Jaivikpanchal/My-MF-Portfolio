<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Portfolio Â· Dec 2027</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0f14;--surface:#13161e;--surface2:#1a1e28;--border:#252933;
    --accent:#00e5a0;--accent2:#3d8bff;--warn:#ff6b6b;--gold:#f5c842;--text:#e8eaf0;--muted:#6b7385}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
  body::before{content:'';position:fixed;top:-200px;left:-200px;width:700px;height:700px;
    background:radial-gradient(circle,rgba(0,229,160,0.07) 0%,transparent 70%);pointer-events:none;z-index:0}
  body::after{content:'';position:fixed;bottom:-200px;right:-200px;width:600px;height:600px;
    background:radial-gradient(circle,rgba(61,139,255,0.05) 0%,transparent 70%);pointer-events:none;z-index:0}
  .wrap{max-width:960px;margin:0 auto;padding:32px 18px;position:relative;z-index:1}

  /* Loader */
  #loader{position:fixed;inset:0;background:var(--bg);z-index:999;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity 0.5s}
  #loader.hide{opacity:0;pointer-events:none}
  .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);
    border-radius:50%;animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #loader p{font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--muted);text-align:center;padding:0 20px}

  /* Header */
  .hdr{margin-bottom:28px}
  .hdr-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
  .hdr h1{font-family:'DM Serif Display',serif;font-size:2rem;line-height:1.15}
  .hdr h1 span{color:var(--accent)}
  .hdr p{font-size:0.82rem;color:var(--muted);margin-top:4px}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .live-btn{display:flex;align-items:center;gap:7px;background:rgba(0,229,160,0.08);
    border:1px solid rgba(0,229,160,0.22);padding:8px 14px;border-radius:999px;
    font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--accent);cursor:pointer;transition:background 0.2s}
  .live-btn:hover{background:rgba(0,229,160,0.16)}
  .sync-btn{display:flex;align-items:center;gap:7px;background:rgba(245,200,66,0.08);
    border:1px solid rgba(245,200,66,0.22);padding:8px 14px;border-radius:999px;
    font-family:'DM Mono',monospace;font-size:0.73rem;color:var(--gold);cursor:pointer;transition:background 0.2s}
  .sync-btn:hover{background:rgba(245,200,66,0.16)}
  .dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.25}}

  .goal-bar{margin-top:14px;background:var(--surface);border:1px solid var(--border);
    border-radius:12px;padding:14px 20px;display:flex;gap:24px;flex-wrap:wrap;align-items:center}
  .gi .gl{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em}
  .gi .gv{font-family:'DM Mono',monospace;font-size:0.92rem;margin-top:3px}
  .col-gold{color:var(--gold)}.col-blue{color:var(--accent2)}.col-green{color:var(--accent)}.col-muted{color:var(--muted)}

  /* Setup Panel */
  #setup{background:var(--surface);border:1px solid rgba(245,200,66,0.3);
    border-radius:14px;padding:24px;margin-bottom:24px;display:none}
  #setup h3{font-family:'DM Serif Display',serif;color:var(--gold);margin-bottom:8px}
  #setup p{font-size:0.8rem;color:var(--muted);margin-bottom:20px;line-height:1.7}
  .input-row{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .input-row label{font-size:0.78rem;color:var(--muted);min-width:130px}
  .input-row input{flex:1;min-width:260px;background:var(--surface2);border:1px solid var(--border);
    color:var(--text);padding:10px 12px;border-radius:8px;font-family:'DM Mono',monospace;
    font-size:0.78rem;outline:none}
  .input-row input:focus{border-color:var(--accent2)}
  .connect-btn{background:var(--accent2);border:none;color:#fff;font-family:'DM Sans',sans-serif;
    font-weight:600;font-size:0.85rem;padding:10px 22px;border-radius:9px;cursor:pointer;
    margin-top:8px;transition:opacity 0.2s}
  .connect-btn:hover{opacity:0.85}

  /* KPI Cards */
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:12px;margin-bottom:28px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 16px;
    transition:border-color 0.2s,transform 0.2s;animation:fadeUp 0.5s ease both}
  .card:hover{border-color:rgba(0,229,160,0.28);transform:translateY(-2px)}
  @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}
  .card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
  .card .cl{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:7px}
  .card .cv{font-family:'DM Mono',monospace;font-size:1.2rem;font-weight:500}
  .card .cs{font-size:0.73rem;color:var(--muted);margin-top:3px}
  .g{color:var(--accent)}.r{color:var(--warn)}.b{color:var(--accent2)}.go{color:var(--gold)}

  /* Section */
  .sec{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);
    margin-bottom:12px;display:flex;align-items:center;gap:10px}
  .sec::after{content:'';flex:1;height:1px;background:var(--border)}

  /* Fund cards */
  .fund{background:var(--surface);border:1px solid var(--border);border-radius:14px;
    padding:20px;margin-bottom:12px;transition:border-color 0.2s,transform 0.2s;animation:fadeUp 0.5s ease both}
  .fund:hover{border-color:rgba(61,139,255,0.28);transform:translateY(-1px)}
  .fund-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
  .fund-left{display:flex;gap:14px}
  .ficon{width:42px;height:42px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;
    justify-content:center;font-family:'DM Mono',monospace;font-size:0.68rem;font-weight:500;color:#fff}
  .fname{font-weight:500;font-size:0.9rem;line-height:1.35}
  .ftype{font-size:0.7rem;color:var(--muted);margin-top:3px}
  .folio-tag{background:rgba(61,139,255,0.08);border:1px solid rgba(61,139,255,0.15);color:var(--muted);
    font-size:0.63rem;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:999px;
    margin-top:5px;display:inline-block}
  .nav-badge{font-family:'DM Mono',monospace;font-size:0.8rem;background:rgba(0,229,160,0.07);
    border:1px solid rgba(0,229,160,0.15);padding:5px 11px;border-radius:8px;color:var(--accent);
    white-space:nowrap;min-width:190px;text-align:center}
  .nav-badge.loading{opacity:0.45;animation:blink 1.2s infinite}
  .nav-badge.error{color:var(--warn);border-color:rgba(255,107,107,0.2);background:rgba(255,107,107,0.05)}
  @keyframes blink{0%,100%{opacity:0.45}50%{opacity:0.15}}
  .fnums{display:flex;gap:20px;flex-wrap:wrap;margin-top:16px;padding-top:14px;border-top:1px solid var(--border)}
  .ni .nl{font-size:0.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em}
  .ni .nv{font-family:'DM Mono',monospace;font-size:0.9rem;margin-top:3px}
  .folio-list{margin-top:12px;padding-top:12px;border-top:1px dashed var(--border)}
  .folio-title{font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px}
  .folio-row{display:flex;gap:16px;flex-wrap:wrap;padding:7px 10px;border-radius:8px;background:var(--surface2);margin-bottom:5px}
  .fi{font-size:0.72rem;color:var(--muted)}.fi span{font-family:'DM Mono',monospace;color:var(--text);margin-left:4px}
  .bar-track{background:var(--surface2);border-radius:999px;height:4px;margin-top:14px;overflow:hidden}
  .bar-fill{height:100%;border-radius:999px}

  /* Status */
  .status{text-align:center;font-family:'DM Mono',monospace;font-size:0.72rem;
    color:var(--muted);margin:-4px 0 20px;padding:10px}
  .status.ok{color:var(--accent)}.status.err{color:var(--warn)}.status.info{color:var(--accent2)}
  .refresh-btn{display:block;margin:0 auto 28px;background:rgba(0,229,160,0.08);
    border:1px solid rgba(0,229,160,0.22);color:var(--accent);font-family:'DM Mono',monospace;
    font-size:0.75rem;padding:9px 20px;border-radius:9px;cursor:pointer;transition:background 0.2s}
  .refresh-btn:hover{background:rgba(0,229,160,0.18)}

  /* Projection */
  .proj-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:28px}
  .proj-box h3{font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:18px}
  .slider-row{display:flex;align-items:center;gap:14px;margin-bottom:20px;flex-wrap:wrap}
  .slider-row label{font-size:0.78rem;color:var(--muted)}
  input[type=range]{-webkit-appearance:none;width:150px;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;
    border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(0,229,160,0.45)}
  #rate-val{font-family:'DM Mono',monospace;color:var(--accent);font-size:0.9rem;min-width:38px}
  .proj-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
  .pi{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
  .pi.hi{background:linear-gradient(135deg,rgba(0,229,160,0.12),rgba(61,139,255,0.12));border-color:rgba(0,229,160,0.28)}
  .pi .pl{font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px}
  .pi .pv{font-family:'DM Mono',monospace;font-size:1rem}
  .pi.hi .pv{color:var(--accent);font-size:1.2rem}
  .prog-wrap{margin-top:18px}
  .prog-labels{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-bottom:6px}
  .prog-track{background:var(--surface2);border-radius:999px;height:10px;overflow:hidden}
  .prog-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 0.5s ease}
  .prog-pct{text-align:center;font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--accent2);margin-top:5px}

  /* Guide */
  .guide-box{background:var(--surface);border:1px solid rgba(245,200,66,0.25);border-radius:14px;padding:22px;margin-bottom:28px}
  .guide-box h3{font-family:'DM Serif Display',serif;font-size:1rem;color:var(--gold);margin-bottom:14px}
  .step{display:flex;gap:14px;margin-bottom:14px;align-items:flex-start}
  .step .num{width:28px;height:28px;border-radius:50%;flex-shrink:0;background:rgba(245,200,66,0.12);
    border:1px solid rgba(245,200,66,0.3);color:var(--gold);font-family:'DM Mono',monospace;
    font-size:0.75rem;display:flex;align-items:center;justify-content:center;font-weight:500}
  .step .txt{font-size:0.82rem;color:var(--text);line-height:1.7}
  .step .txt code{background:var(--surface2);border:1px solid var(--border);padding:1px 6px;
    border-radius:4px;font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--accent2)}
  .step .txt a{color:var(--accent2)}
  .step .txt strong{color:var(--text)}

  .api-note{background:var(--surface2);border:1px solid var(--border);border-radius:10px;
    padding:14px 18px;font-size:0.73rem;color:var(--muted);text-align:center;margin-bottom:24px}
  .api-note a{color:var(--accent2);text-decoration:none}

  @media(max-width:520px){.hdr h1{font-size:1.5rem}.fnums{gap:12px}.nav-badge{min-width:unset}}
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p id="loader-msg">Loading your portfolioâ€¦</p>
</div>

<div class="wrap">

  <div class="hdr">
    <div class="hdr-top">
      <div>
        <h1>My Portfolio<br><span>Live NAV Tracker</span></h1>
        <p>Furniture &amp; Interior Goal Â· December 2027 Â· Powered by Google Sheets + mfapi.in</p>
      </div>
      <div class="btn-row">
        <button class="sync-btn" onclick="syncData()">â†» &nbsp;Sync Sheet</button>
        <button class="live-btn" onclick="fetchNAVs()"><div class="dot"></div> LIVE NAV</button>
      </div>
    </div>
    <div class="goal-bar">
      <div class="gi"><div class="gl">Total Invested</div><div class="gv col-blue" id="hdr-inv">â€”</div></div>
      <div class="gi"><div class="gl">Live Value</div><div class="gv col-green" id="hdr-val">â€”</div></div>
      <div class="gi"><div class="gl">Monthly SIP</div><div class="gv col-gold">â‚¹70,000/mo</div></div>
      <div class="gi"><div class="gl">Months to Goal</div><div class="gv col-green" id="months-left">â€”</div></div>
      <div class="gi"><div class="gl">Last Synced</div><div class="gv col-muted" id="sync-time">â€”</div></div>
    </div>
  </div>

  <!-- Setup panel â€” shown only first time -->
  <div id="setup">
    <h3>ðŸ”— One-Time Setup â€” Paste Your Apps Script URL</h3>
    <p>
      You only do this once. After setup, your dashboard syncs automatically every time you update your Google Sheet.<br>
      Follow the steps at the bottom of this page to get your Apps Script URL.
    </p>
    <div class="input-row">
      <label>Apps Script URL</label>
      <input type="text" id="api-url-input" placeholder="https://script.google.com/macros/s/XXXX/exec">
    </div>
    <div class="input-row">
      <label>Goal Amount (â‚¹)</label>
      <input type="number" id="goal-input" value="2000000">
    </div>
    <button class="connect-btn" onclick="saveAndConnect()">ðŸ”Œ &nbsp;Connect Dashboard</button>
  </div>

  <!-- KPI Cards -->
  <div class="cards">
    <div class="card"><div class="cl">Total Invested</div><div class="cv b" id="kpi-inv">â€”</div><div class="cs" id="kpi-sub">â€”</div></div>
    <div class="card"><div class="cl">Live Value</div><div class="cv g" id="kpi-val">â€”</div><div class="cs">Units Ã— Live NAV</div></div>
    <div class="card"><div class="cl">Total Gain / Loss</div><div class="cv" id="kpi-gain">â€”</div><div class="cs" id="kpi-pct">â€”</div></div>
    <div class="card"><div class="cl">Avg XIRR</div><div class="cv go" id="kpi-xirr">â€”</div><div class="cs">From your broker</div></div>
  </div>

  <div class="sec">Your Holdings â€” folios auto-merged</div>
  <div id="funds-wrap"></div>

  <div class="status" id="status">Connectingâ€¦</div>
  <button class="refresh-btn" onclick="fetchNAVs()">âŸ³ &nbsp;Refresh Live NAV</button>

  <div class="sec">Dec 2027 Projection</div>
  <div class="proj-box">
    <h3>Corpus Estimator</h3>
    <div class="slider-row">
      <label>Expected Annual Return:</label>
      <input type="range" id="rate" min="6" max="15" value="8" step="0.5" oninput="calcProj()">
      <span id="rate-val">8%</span>
    </div>
    <div class="proj-grid">
      <div class="pi"><div class="pl">Current Corpus</div><div class="pv" id="p-corpus">â€”</div></div>
      <div class="pi"><div class="pl">SIP Ã— Months Left</div><div class="pv" id="p-sip">â€”</div></div>
      <div class="pi"><div class="pl">Growth Earned</div><div class="pv" id="p-growth">â€”</div></div>
      <div class="pi hi"><div class="pl">ðŸŽ¯ Total by Dec 2027</div><div class="pv" id="p-total">â€”</div></div>
    </div>
    <div class="prog-wrap">
      <div class="prog-labels"><span id="prog-l">Now: â€”</span><span id="prog-r">Target: â€”</span></div>
      <div class="prog-track"><div class="prog-fill" id="prog" style="width:0%"></div></div>
      <div class="prog-pct" id="prog-pct">â€”</div>
    </div>
  </div>

  <!-- Setup Guide -->
  <div class="sec">One-Time Setup Guide â€” 5 Minutes</div>
  <div class="guide-box">
    <h3>ðŸš€ Connect Google Sheets via Apps Script</h3>
    <div class="step">
      <div class="num">1</div>
      <div class="txt">Open your Google Sheet â†’ click <strong>Extensions</strong> â†’ <strong>Apps Script</strong></div>
    </div>
    <div class="step">
      <div class="num">2</div>
      <div class="txt">Delete everything in the editor â†’ paste the <code>apps_script.gs</code> file content â†’ press <strong>Ctrl+S</strong> to save</div>
    </div>
    <div class="step">
      <div class="num">3</div>
      <div class="txt">Click <strong>Deploy</strong> â†’ <strong>New Deployment</strong> â†’ click âš™ gear icon â†’ select <strong>Web app</strong></div>
    </div>
    <div class="step">
      <div class="num">4</div>
      <div class="txt">Set: <code>Execute as: Me</code> Â· <code>Who has access: Anyone</code> â†’ click <strong>Deploy</strong> â†’ click <strong>Authorize access</strong> â†’ allow permissions</div>
    </div>
    <div class="step">
      <div class="num">5</div>
      <div class="txt">Copy the <strong>Web app URL</strong> â†’ paste it in the setup box at the top of this page â†’ click <strong>Connect Dashboard</strong></div>
    </div>
    <div class="step">
      <div class="num">â™»</div>
      <div class="txt" style="color:var(--accent)">
        <strong>Every month after SIP:</strong> Export CSV from Kuvera â†’ paste into Google Sheet â†’ click <strong>â†» Sync Sheet</strong> on this dashboard. That's it â€” fully automatic! ðŸŽ¯
      </div>
    </div>
  </div>

  <div class="api-note">
    Portfolio data: Google Apps Script API (your sheet) Â· Live NAV: <a href="https://mfapi.in" target="_blank">mfapi.in</a> Â· AMFI India Â· No third-party proxies
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GOAL_DATE = new Date(2027, 11, 6);
const SIP       = 70000;

const FUND_META = [
  { key:'kotak arbitrage',              short:'KA', code:'119551', cs:'#1a56db', ce:'#3d8bff' },
  { key:'icici prudential multi asset', short:'MA', code:'18485',  cs:'#f59e0b', ce:'#fbbf24' },
  { key:'icici prudential equity sav',  short:'ES', code:'31233',  cs:'#0e9f6e', ce:'#34d399' },
];

let FUNDS = [], liveCorpus = 0;
const inr  = v => 'â‚¹' + Math.round(v).toLocaleString('en-IN');
const inrL = v => v >= 1e5 ? 'â‚¹' + (v/1e5).toFixed(2) + ' L' : inr(v);
const mo   = (a,b) => (b.getFullYear()-a.getFullYear())*12+(b.getMonth()-a.getMonth());

function matchMeta(name) {
  const n = name.toLowerCase();
  return FUND_META.find(m => n.includes(m.key)) || {short:name.slice(0,2).toUpperCase(), code:null, cs:'#6b7385', ce:'#9ca3af'};
}

// â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSetup() {
  document.getElementById('setup').style.display = 'block';
  document.getElementById('loader').classList.add('hide');
}

function saveAndConnect() {
  const url  = document.getElementById('api-url-input').value.trim();
  const goal = document.getElementById('goal-input').value || '2000000';
  if (!url || !url.includes('script.google.com')) {
    alert('Please paste a valid Google Apps Script URL\n(should start with https://script.google.com)');
    return;
  }
  localStorage.setItem('mf_api_url', url);
  localStorage.setItem('mf_goal',    goal);
  document.getElementById('setup').style.display = 'none';
  syncData();
}

// â”€â”€ Fetch from Apps Script API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncData() {
  const url = localStorage.getItem('mf_api_url');
  if (!url) { showSetup(); return; }

  document.getElementById('loader-msg').textContent = 'Syncing from Google Sheets...';
  document.getElementById('loader').classList.remove('hide');

  try {
    // Add redirect: 'follow' to handle Google's 302 redirect
    const res = await fetch(url, { 
      method: 'GET',
      redirect: 'follow' 
    });
    
    const data = await res.json();

    if (data.status === 'error') throw new Error(data.error);
    
    // Attach display meta
    FUNDS = data.funds.map(f => ({ ...f, ...matchMeta(f.name) }));

    document.getElementById('sync-time').textContent = new Date().toLocaleTimeString('en-IN');
    render();
    fetchNAVs(); // Automatically fetch Live NAVs after sync

  } catch(e) {
    console.error(e);
    document.getElementById('loader').classList.add('hide');
    setStatus('err', 'âš  Sync Failed: ' + e.message);
    // If it fails, let the user re-check the URL
    showSetup();
  }
}

// â”€â”€ Render dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const totalInv  = FUNDS.reduce((s,f) => s+f.invested, 0);
  const totalVal  = FUNDS.reduce((s,f) => s+f.cur_val,  0);
  const totalGain = totalVal - totalInv;
  const gpct      = totalGain / totalInv * 100;
  const avgXirr   = FUNDS.reduce((s,f) => s+f.avg_xirr, 0) / FUNDS.length;
  const months    = mo(new Date(), GOAL_DATE);

  document.getElementById('hdr-inv').textContent     = inr(totalInv);
  document.getElementById('hdr-val').textContent     = inr(totalVal);
  document.getElementById('months-left').textContent = months + ' months';
  document.getElementById('kpi-inv').textContent     = inr(totalInv);
  document.getElementById('kpi-sub').textContent     = FUNDS.length + ' funds Â· ' + FUNDS.reduce((s,f)=>s+f.folios.length,0) + ' folios';
  document.getElementById('kpi-val').textContent     = inr(totalVal);
  document.getElementById('kpi-gain').textContent    = (totalGain>=0?'+':'âˆ’')+inr(Math.abs(totalGain));
  document.getElementById('kpi-gain').className      = 'cv '+(totalGain>=0?'g':'r');
  document.getElementById('kpi-pct').textContent     = (gpct>=0?'+':'')+gpct.toFixed(2)+'%';
  document.getElementById('kpi-pct').className       = 'cs '+(gpct>=0?'g':'r');
  document.getElementById('kpi-xirr').textContent    = avgXirr.toFixed(2)+'%';

  const wrap = document.getElementById('funds-wrap');
  wrap.innerHTML = '';
  FUNDS.forEach((f,i) => {
    const pct   = (f.invested/totalInv*100).toFixed(1);
    const gain  = f.cur_val - f.invested;
    const gpct2 = (gain/f.invested*100).toFixed(2);
    const folioHTML = f.folios.map(fl=>`
      <div class="folio-row">
        <div class="fi">Folio <span>${fl.folio}</span></div>
        <div class="fi">Invested <span>${inr(fl.invested)}</span></div>
        <div class="fi">Units <span>${fl.units.toFixed(4)}</span></div>
        <div class="fi">Avg NAV <span>â‚¹${fl.avg_nav.toFixed(4)}</span></div>
        <div class="fi">XIRR <span class="${fl.xirr>=0?'g':'r'}">${fl.xirr.toFixed(2)}%</span></div>
      </div>`).join('');
    const d = document.createElement('div');
    d.className = 'fund';
    d.style.animationDelay = (0.08+i*0.08)+'s';
    d.innerHTML = `
      <div class="fund-top">
        <div class="fund-left">
          <div class="ficon" style="background:linear-gradient(135deg,${f.cs},${f.ce})">${f.short}</div>
          <div>
            <div class="fname">${f.name}</div>
            <div class="ftype">${f.category} Â· ${f.folios.length} folio${f.folios.length>1?'s':''}</div>
            <div class="folio-tag">${f.folios.map(fl=>fl.folio).join(' Â· ')}</div>
          </div>
        </div>
        <div class="nav-badge loading" id="nb${i}">Fetching live NAVâ€¦</div>
      </div>
      <div class="fnums">
        <div class="ni"><div class="nl">Invested</div><div class="nv">${inr(f.invested)}</div></div>
        <div class="ni"><div class="nl">Total Units</div><div class="nv">${f.units.toFixed(4)}</div></div>
        <div class="ni"><div class="nl">Avg Buy NAV</div><div class="nv">â‚¹${f.avg_nav.toFixed(4)}</div></div>
        <div class="ni"><div class="nl">Sheet Value</div><div class="nv">${inr(f.cur_val)}</div></div>
        <div class="ni"><div class="nl">Live Value</div><div class="nv" id="lv${i}">Calculatingâ€¦</div></div>
        <div class="ni"><div class="nl">Gain/Loss</div><div class="nv ${gain>=0?'g':'r'}">${gain>=0?'+':'âˆ’'}${inr(Math.abs(gain))} (${gpct2}%)</div></div>
        <div class="ni"><div class="nl">XIRR</div><div class="nv ${f.avg_xirr>=0?'go':'r'}">${f.avg_xirr.toFixed(2)}%</div></div>
        <div class="ni"><div class="nl">Portfolio</div><div class="nv">${pct}%</div></div>
      </div>
      <div class="folio-list">
        <div class="folio-title">Folio Breakdown</div>
        ${folioHTML}
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:linear-gradient(90deg,${f.cs},${f.ce})"></div></div>`;
    wrap.appendChild(d);
  });

  liveCorpus = totalVal;
  calcProj();
  document.getElementById('loader').classList.add('hide');
}

// â”€â”€ Live NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function tryFetch(url) {
  try {
    const r = await fetch(url, {signal: AbortSignal.timeout(6000)});
    if (r.ok) return r.json();
  } catch {}
  try {
    const r = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, {signal: AbortSignal.timeout(6000)});
    if (r.ok) return r.json();
  } catch {}
  return null;
}

async function fetchOne(i) {
  const f=FUNDS[i], nb=document.getElementById(`nb${i}`), lv=document.getElementById(`lv${i}`);
  nb.className = 'nav-badge loading';
  if (!f.code) { nb.className='nav-badge error'; nb.textContent='Code not mapped'; lv.textContent=inr(f.cur_val); return {val:f.cur_val,ok:false}; }
  const data = await tryFetch(`https://api.mfapi.in/mf/${f.code}/latest`);
  if (data?.status==='SUCCESS' && data.data?.[0]) {
    const nav=parseFloat(data.data[0].nav), val=f.units*nav;
    nb.className='nav-badge';
    nb.textContent=`NAV â‚¹${nav.toFixed(4)} Â· ${data.data[0].date}`;
    lv.textContent=inr(val);
    return {val, ok:true};
  }
  nb.className='nav-badge error'; nb.textContent='NAV unavailable'; lv.textContent=inr(f.cur_val);
  return {val:f.cur_val, ok:false};
}

async function fetchNAVs() {
  if (!FUNDS.length) return;
  setStatus('', 'Fetching live NAV from mfapi.inâ€¦');
  const results  = await Promise.all(FUNDS.map((_,i) => fetchOne(i)));
  const ok       = results.filter(r=>r.ok).length;
  const totalVal = results.reduce((s,r)=>s+r.val, 0);
  const totalInv = FUNDS.reduce((s,f)=>s+f.invested, 0);
  const gain=totalVal-totalInv, gpct=(gain/totalInv*100);

  document.getElementById('kpi-val').textContent  = inr(totalVal);
  document.getElementById('hdr-val').textContent  = inr(totalVal);
  document.getElementById('kpi-gain').textContent = (gain>=0?'+':'âˆ’')+inr(Math.abs(gain));
  document.getElementById('kpi-gain').className   = 'cv '+(gain>=0?'g':'r');
  document.getElementById('kpi-pct').textContent  = (gpct>=0?'+':'')+gpct.toFixed(2)+'%';
  document.getElementById('kpi-pct').className    = 'cs '+(gpct>=0?'g':'r');
  liveCorpus = totalVal; calcProj();

  if (ok===FUNDS.length) setStatus('ok', `âœ“ All ${ok} NAVs updated Â· ${new Date().toLocaleTimeString('en-IN')}`);
  else if (ok>0) setStatus('info', `âš  ${ok}/${FUNDS.length} NAVs loaded`);
  else setStatus('err', 'âš  NAV fetch failed Â· check network');
}

// â”€â”€ Projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcProj() {
  const rate=parseFloat(document.getElementById('rate').value);
  document.getElementById('rate-val').textContent = rate+'%';
  const r=rate/100/12, n=mo(new Date(),GOAL_DATE);
  const c=liveCorpus||FUNDS.reduce((s,f)=>s+f.invested,0);
  const GOAL=parseInt(localStorage.getItem('mf_goal')||2000000);
  const fvC=c*Math.pow(1+r,n), fvS=SIP*((Math.pow(1+r,n)-1)/r)*(1+r);
  const tot=fvC+fvS, grow=tot-c-SIP*n, pct=Math.min(tot/GOAL*100,100);
  document.getElementById('p-corpus').textContent = inrL(c);
  document.getElementById('p-sip').textContent    = inrL(SIP*n);
  document.getElementById('p-growth').textContent = inrL(grow);
  document.getElementById('p-total').textContent  = inrL(tot);
  document.getElementById('prog-l').textContent   = 'Now: '+inrL(c);
  document.getElementById('prog-r').textContent   = 'Target: '+inrL(GOAL);
  document.getElementById('prog').style.width     = pct+'%';
  document.getElementById('prog-pct').textContent = pct.toFixed(1)+'% of '+inrL(GOAL)+' goal';
}

function setStatus(cls, msg) {
  const el=document.getElementById('status');
  el.className='status'+(cls?' '+cls:''); el.textContent=msg;
}

document.getElementById('rate').addEventListener('input', calcProj);

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const savedUrl = localStorage.getItem('mf_api_url');
if (savedUrl) syncData(); else showSetup();
</script>
</body>
</html>
