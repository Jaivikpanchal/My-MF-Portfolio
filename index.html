<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Tracker ¬∑ Live NAV</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0f14;--surface:#13161e;--surface2:#1a1e28;--border:#252933;
    --accent:#00e5a0;--accent2:#3d8bff;--warn:#ff6b6b;--text:#e8eaf0;--muted:#6b7385}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
  body::before{content:'';position:fixed;top:-200px;left:-200px;width:700px;height:700px;
    background:radial-gradient(circle,rgba(0,229,160,0.07) 0%,transparent 70%);pointer-events:none;z-index:0}
  body::after{content:'';position:fixed;bottom:-200px;right:-200px;width:600px;height:600px;
    background:radial-gradient(circle,rgba(61,139,255,0.05) 0%,transparent 70%);pointer-events:none;z-index:0}
  .wrap{max-width:1200px;margin:0 auto;padding:32px 18px;position:relative;z-index:1}

  #loader{position:fixed;inset:0;background:var(--bg);z-index:999;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;opacity:1;transition:opacity 0.5s}
  #loader.hide{opacity:0;pointer-events:none}
  .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);
    border-radius:50%;animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .hdr{margin-bottom:28px}
  .hdr-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
  .hdr h1{font-family:'DM Serif Display',serif;font-size:2rem;line-height:1.15}
  .hdr h1 span{color:var(--accent)}
  .hdr p{font-size:0.82rem;color:var(--muted);margin-top:4px}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:flex;align-items:center;gap:7px;padding:10px 16px;border-radius:999px;
    font-family:'DM Mono',monospace;font-size:0.78rem;cursor:pointer;border:1px solid;font-weight:600;background:rgba(0,229,160,0.08);border-color:rgba(0,229,160,0.22);color:var(--accent);transition:background 0.2s}
  .btn:hover{background:rgba(0,229,160,0.16)}

  .goal-bar{margin-top:14px;background:var(--surface);border:1px solid var(--border);
    border-radius:12px;padding:16px 20px;display:flex;gap:24px;flex-wrap:wrap}
  .gi{min-width:140px}
  .gi .gl{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em}
  .gi .gv{font-family:'DM Mono',monospace;font-size:0.95rem;margin-top:6px;font-weight:600}
  .col-green{color:var(--accent)}.col-red{color:var(--warn)}

  .setup-panel{background:var(--surface);border:1px solid rgba(61,139,255,0.3);border-radius:14px;
    padding:24px;margin-bottom:24px}
  .setup-panel h3{font-family:'DM Serif Display',serif;color:var(--accent2);margin-bottom:12px}
  .input-group{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .input-group input{flex:1;min-width:260px;background:var(--surface2);border:1px solid var(--border);
    color:var(--text);padding:10px 12px;border-radius:8px;font-family:'DM Mono',monospace;font-size:0.78rem}
  .input-group input:focus{border-color:var(--accent2);outline:none}
  .save-btn{background:var(--accent2);border:none;color:#fff;padding:10px 18px;border-radius:8px;
    cursor:pointer;font-weight:600;font-size:0.82rem;transition:opacity 0.2s}
  .save-btn:hover{opacity:0.85}

  .sec{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);
    margin-bottom:12px;display:flex;align-items:center;gap:10px;margin-top:28px}
  .sec::after{content:'';flex:1;height:1px;background:var(--border)}
  .sec.first{margin-top:0}

  .holdings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-bottom:28px}
  .holding-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;
    transition:all 0.2s;animation:fadeUp 0.5s ease both}
  .holding-card:hover{border-color:rgba(61,139,255,0.28);transform:translateY(-2px)}
  @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

  .holding-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:16px}
  .holding-header h3{font-size:0.95rem;font-weight:600;margin-bottom:4px}
  .holding-header p{font-size:0.75rem;color:var(--muted)}
  .badge{background:rgba(61,139,255,0.08);border:1px solid rgba(61,139,255,0.15);
    color:var(--accent2);font-size:0.7rem;padding:5px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-weight:600}
  .nav-badge{background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.15);
    color:var(--accent);font-size:0.65rem;padding:4px 8px;border-radius:4px;font-family:'DM Mono',monospace;margin-top:4px}

  .stat-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:0.85rem}
  .stat-row:last-child{border-bottom:none}
  .stat-label{color:var(--muted)}
  .stat-value{font-family:'DM Mono',monospace;font-weight:600}

  .status{text-align:center;font-family:'DM Mono',monospace;font-size:0.75rem;
    color:var(--muted);margin:20px 0;padding:12px}
  .status.ok{color:var(--accent)}.status.err{color:var(--warn)}.status.info{color:var(--accent2)}

  .summary{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;
    margin-bottom:28px}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px}
  .summary-item .label{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em}
  .summary-item .value{font-family:'DM Mono',monospace;font-size:1.15rem;font-weight:600;margin-top:10px}

  .live-indicator{display:inline-flex;align-items:center;gap:6px;font-size:0.7rem;color:var(--accent);margin-top:8px}
  .live-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p>Loading portfolio...</p>
</div>

<div class="wrap">

  <div class="hdr">
    <div class="hdr-top">
      <div>
        <h1>Portfolio <span id="hdr-val">‚Çπ0</span></h1>
        <p>Live NAV from AMFI + Transaction History</p>
      </div>
      <div class="btn-row">
        <button class="btn" onclick="loadPortfolio()">üîÑ Refresh</button>
        <button class="btn" onclick="toggleSetup()">‚öôÔ∏è Setup</button>
      </div>
    </div>
    <div class="goal-bar">
      <div class="gi">
        <div class="gl">Portfolio Value (Live)</div>
        <div class="gv col-green" id="total-value">‚Çπ0</div>
      </div>
      <div class="gi">
        <div class="gl">Total Invested</div>
        <div class="gv" id="total-invested">‚Çπ0</div>
      </div>
      <div class="gi">
        <div class="gl">Total Gain/Loss</div>
        <div class="gv" id="total-return">‚Çπ0</div>
      </div>
      <div class="gi">
        <div class="gl">Return %</div>
        <div class="gv col-green" id="total-pct">0%</div>
      </div>
    </div>
  </div>

  <div id="setup" class="setup-panel" style="display:none">
    <h3>üîó GitHub Configuration</h3>
    <div class="input-group">
      <input type="text" id="ghUser" placeholder="GitHub username" style="flex:1">
      <input type="text" id="ghRepo" placeholder="Repository" style="flex:1">
      <input type="password" id="ghToken" placeholder="Access token" style="flex:1">
      <button class="save-btn" onclick="saveConfig()">Save</button>
    </div>
    <div id="setup-status" class="status"></div>
  </div>

  <div id="status" class="status"></div>

  <div class="summary">
    <div class="summary-grid">
      <div class="summary-item">
        <div class="label">Holdings</div>
        <div class="value" id="count">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Portfolio Value</div>
        <div class="value col-green" id="summary-value">‚Çπ0</div>
      </div>
      <div class="summary-item">
        <div class="label">Total Invested</div>
        <div class="value" id="summary-invested">‚Çπ0</div>
      </div>
      <div class="summary-item">
        <div class="label">Total Return %</div>
        <div class="value col-green" id="summary-pct">0%</div>
      </div>
    </div>
    <div class="live-indicator">
      <div class="live-dot"></div>
      <span>Live NAV prices from AMFI</span>
    </div>
  </div>

  <div class="sec first">Current Holdings (With Live NAV)</div>
  <div id="current-holdings" class="holdings-grid"></div>

  <div class="sec">All Transactions History</div>
  <div id="transactions" class="holdings-grid"></div>

</div>

<script>
// AMFI Fund Codes for Live NAV
const AMFI_CODES = {
  'INF174K01LC6': 'Kotak Arbitrage Growth Direct',
  'INF109K015K4': 'ICICI Prudential Multi Asset Growth Direct',
  'INF109KA11J9': 'ICICI Prudential Equity Saving Cumulative'
};

// Map AMFI codes to your fund names (update as needed)
const FUND_MAPPING = {
  'kotak-arbitrage-fund-direct-plan-growth': 'INF174K01LC6',
  'icici-prudential-multi-asset-fund-direct-plan-g': 'INF109K015K4',
  'icici-prudential-equity-savings-fund-direct-plan-c': 'INF109KA11J9'
};

let allTransactions = [];
let liveNAVs = {};

function inr(v) {
  return new Intl.NumberFormat('en-IN', {style: 'currency', currency: 'INR', minimumFractionDigits: 0}).format(v);
}

function toggleSetup() {
  const setup = document.getElementById('setup');
  setup.style.display = setup.style.display === 'none' ? 'block' : 'none';
  if (setup.style.display === 'block') {
    document.getElementById('ghUser').value = localStorage.getItem('gh_user') || '';
    document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
    document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
  }
}

function saveConfig() {
  const u = document.getElementById('ghUser').value;
  const r = document.getElementById('ghRepo').value;
  const t = document.getElementById('ghToken').value;
  if (!u || !r || !t) { setStatus('setup-status', 'err', 'All fields required'); return; }
  localStorage.setItem('gh_user', u);
  localStorage.setItem('gh_repo', r);
  localStorage.setItem('gh_token', t);
  setStatus('setup-status', 'ok', '‚úì Saved!');
  document.getElementById('setup').style.display = 'none';
  loadPortfolio();
}

// ===== FETCH LIVE NAV FROM AMFI =====
async function fetchLiveNAV() {
  try {
    setStatus('status', '', 'üìà Fetching live NAV...');
    
    const response = await fetch('https://www.amfiindia.com/spages/NAVAll.txt');
    const text = await response.text();
    
    const lines = text.split('\n');
    liveNAVs = {};
    
    // Parse NAV data
    lines.forEach(line => {
      const parts = line.split(';');
      if (parts.length >= 4) {
        const code = parts[0].trim();
        const nav = parseFloat(parts[3].trim());
        if (!isNaN(nav)) {
          liveNAVs[code] = nav;
        }
      }
    });
    
    console.log("Loaded live NAVs:", Object.keys(liveNAVs).length, "funds");
    return true;
  } catch (err) {
    console.error("Failed to fetch NAV:", err);
    setStatus('status', 'warn', '‚ö† NAV fetch failed, using historical data');
    return false;
  }
}

// ===== LOAD PORTFOLIO FROM GITHUB =====
async function loadPortfolio() {
  const u = localStorage.getItem('gh_user');
  const r = localStorage.getItem('gh_repo');
  const t = localStorage.getItem('gh_token');
  
  if (!u || !r || !t) {
    document.getElementById('setup').style.display = 'block';
    return;
  }
  
  setStatus('status', '', 'üîÑ Loading portfolio...');
  
  try {
    // Fetch live NAV
    await fetchLiveNAV();
    
    // Get list of CSV files in history/ folder
    const response = await fetch(
      `https://api.github.com/repos/${u}/${r}/contents/data/history`,
      { headers: { 'Authorization': `token ${t}`, 'Accept': 'application/vnd.github.v3+json' } }
    );
    
    if (!response.ok) throw new Error('Folder not found');
    
    const files = await response.json();
    const csvFiles = files.filter(f => f.name.endsWith('.csv')).sort().reverse();
    
    allTransactions = [];
    
    // Read each CSV file
    for (let file of csvFiles) {
      const csvResponse = await fetch(file.download_url);
      const csv = await csvResponse.text();
      const lines = csv.trim().split('\n').slice(1); // Skip header
      
      lines.forEach(line => {
        if (!line) return;
        const parts = line.split(',');
        allTransactions.push({
          date: parts[0],
          folio: parts[1],
          fundHouse: parts[2],
          fundName: parts[3].replace(/"/g, ''),
          invested: parseFloat(parts[4]),
          units: parseFloat(parts[5]),
          historicalNAV: parseFloat(parts[6]),
          historicalValue: parseFloat(parts[7])
        });
      });
    }
    
    displayPortfolio();
    setStatus('status', 'ok', '‚úì Loaded ' + allTransactions.length + ' transactions');
  } catch (err) {
    setStatus('status', 'err', '‚ö† ' + err.message);
  }
}

// ===== DISPLAY PORTFOLIO =====
function displayPortfolio() {
  // Group by folio + fund name to get current holdings
  const holdingsByFund = {};
  
  allTransactions.forEach(t => {
    const key = t.folio + '|' + t.fundName;
    if (!holdingsByFund[key]) {
      holdingsByFund[key] = {
        folio: t.folio,
        fundHouse: t.fundHouse,
        fundName: t.fundName,
        totalUnits: 0,
        totalInvested: 0,
        transactions: []
      };
    }
    holdingsByFund[key].totalUnits += t.units;
    holdingsByFund[key].totalInvested += t.invested;
    holdingsByFund[key].transactions.push(t);
  });

  const holdings = Object.values(holdingsByFund);
  
  // Calculate current values with live NAV
  let totalInvested = 0;
  let totalCurrentValue = 0;
  
  holdings.forEach(h => {
    totalInvested += h.totalInvested;
    
    // Try to find live NAV for this fund
    let liveNAV = h.transactions[h.transactions.length - 1].historicalNAV; // Default to last known
    
    for (let code in FUND_MAPPING) {
      if (h.fundName.toLowerCase().includes(code.replace(/-/g, ' '))) {
        const amfiCode = FUND_MAPPING[code];
        if (liveNAVs[amfiCode]) {
          liveNAV = liveNAVs[amfiCode];
          break;
        }
      }
    }
    
    h.liveNAV = liveNAV;
    h.liveValue = h.totalUnits * liveNAV;
    totalCurrentValue += h.liveValue;
  });
  
  const totalGain = totalCurrentValue - totalInvested;
  const totalPct = totalInvested > 0 ? ((totalGain / totalInvested) * 100).toFixed(2) : 0;
  
  // Update header
  document.getElementById('hdr-val').textContent = inr(totalCurrentValue);
  document.getElementById('total-value').textContent = inr(totalCurrentValue);
  document.getElementById('total-invested').textContent = inr(totalInvested);
  document.getElementById('total-return').textContent = `${totalGain >= 0 ? '+' : '‚àí'}${inr(Math.abs(totalGain))}`;
  document.getElementById('total-return').className = `gv ${totalGain >= 0 ? 'col-green' : 'col-red'}`;
  document.getElementById('total-pct').textContent = `${totalPct}%`;
  document.getElementById('total-pct').className = `gv ${totalGain >= 0 ? 'col-green' : 'col-red'}`;
  
  // Update summary
  document.getElementById('count').textContent = holdings.length;
  document.getElementById('summary-value').textContent = inr(totalCurrentValue);
  document.getElementById('summary-invested').textContent = inr(totalInvested);
  document.getElementById('summary-pct').textContent = `${totalPct}%`;
  
  // Display current holdings
  const currentContainer = document.getElementById('current-holdings');
  currentContainer.innerHTML = '';
  
  holdings.forEach((h, i) => {
    const gain = h.liveValue - h.totalInvested;
    const gainPct = h.totalInvested > 0 ? ((gain / h.totalInvested) * 100).toFixed(2) : 0;
    
    const card = document.createElement('div');
    card.className = 'holding-card';
    card.style.animationDelay = (i * 0.05) + 's';
    card.innerHTML = `
      <div class="holding-header">
        <div>
          <h3>${h.fundName}</h3>
          <p>${h.fundHouse}</p>
        </div>
        <div class="badge">${h.folio}</div>
      </div>
      <div class="stat-row">
        <span class="stat-label">Units</span>
        <span class="stat-value">${h.totalUnits.toFixed(4)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Live NAV</span>
        <span class="stat-value">‚Çπ${h.liveNAV.toFixed(4)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Current Value</span>
        <span class="stat-value">${inr(h.liveValue)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Invested</span>
        <span class="stat-value">${inr(h.totalInvested)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Gain/Loss</span>
        <span class="stat-value" style="color:${gain >= 0 ? 'var(--accent)' : 'var(--warn)'}">${gain >= 0 ? '+' : ''}${inr(Math.abs(gain))} (${gainPct}%)</span>
      </div>
      <div class="nav-badge">Live NAV from AMFI</div>
    `;
    currentContainer.appendChild(card);
  });
  
  // Display all transactions
  const txnContainer = document.getElementById('transactions');
  txnContainer.innerHTML = '';
  
  allTransactions.forEach((t, i) => {
    const card = document.createElement('div');
    card.className = 'holding-card';
    card.style.animationDelay = (i * 0.03) + 's';
    card.innerHTML = `
      <div class="holding-header">
        <div>
          <h3>${t.fundName}</h3>
          <p>${t.fundHouse}</p>
        </div>
        <div class="badge">${t.folio}</div>
      </div>
      <div class="stat-row">
        <span class="stat-label">Date</span>
        <span class="stat-value">${t.date}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Invested</span>
        <span class="stat-value">${inr(t.invested)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Units</span>
        <span class="stat-value">${t.units.toFixed(4)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">NAV at Purchase</span>
        <span class="stat-value">‚Çπ${t.historicalNAV.toFixed(4)}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Value at Purchase</span>
        <span class="stat-value">${inr(t.historicalValue)}</span>
      </div>
    `;
    txnContainer.appendChild(card);
  });
  
  document.getElementById('loader').classList.add('hide');
}

function setStatus(id, cls, msg) {
  const el = document.getElementById(id);
  el.className = 'status ' + cls;
  el.textContent = msg;
}

window.addEventListener('load', () => {
  if (localStorage.getItem('gh_user')) {
    loadPortfolio();
  } else {
    document.getElementById('loader').classList.add('hide');
    document.getElementById('setup').style.display = 'block';
  }
});
</script>

</body>
</html>
